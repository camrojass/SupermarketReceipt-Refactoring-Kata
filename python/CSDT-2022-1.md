# CSDT-2022-1

La solución en Python consiste en un supermercado que dispone de un catálogo con diferentes tipos de productos (arroz, manzanas, leche, cepillos de dientes,etc.). Cada producto tiene precio, y el precio total del carrito de compras es el total de todos los precios de los artículos. La solución da un recibo que detalla los artículos que compró, el precio total y los descuentos que se aplicaron.

El supermercado ofrece ofertas especiales, por ejemplo:
 - Compra dos cepillos de dientes, llévate uno gratis. El precio del cepillo de dientes normal es de 0,99€
 - 20% de descuento en manzanas, precio normal 1,99€ el kilo.
 - 10% de descuento en arroz, precio normal 2,49€ la bolsa
 - Cinco tubos de pasta de dientes por 7,49 €, precio normal 1,79 €
 - Dos cajas de tomates cherry por 0,99€, precio normal 0,69€ la caja.

## Code Smells detectados

 1. "Bloaters" en el código "shopping_cart.py" utiliza 'if' para detallar todas las ofertas posibles, dificultando agregar nuevas ofertas.
 
  ``` 
                if p in offers.keys():
                offer = offers[p]
                unit_price = catalog.unit_price(p)
                quantity_as_int = int(quantity)
                discount = None
                x = 1
                if offer.offer_type == SpecialOfferType.THREE_FOR_TWO:
                    x = 3
 
                elif offer.offer_type == SpecialOfferType.TWO_FOR_AMOUNT:
                    x = 2
                    if quantity_as_int >= 2:
                        total = offer.argument * (quantity_as_int / x) + quantity_as_int % 2 * unit_price
                        discount_n = unit_price * quantity - total
                        discount = Discount(p, "2 for " + str(offer.argument), -discount_n)
 
                if offer.offer_type == SpecialOfferType.FIVE_FOR_AMOUNT:
                    x = 5
 
                number_of_x = math.floor(quantity_as_int / x)
                if offer.offer_type == SpecialOfferType.THREE_FOR_TWO and quantity_as_int > 2:
                    discount_amount = quantity * unit_price - (
                                (number_of_x * 2 * unit_price) + quantity_as_int % 3 * unit_price)
                    discount = Discount(p, "3 for 2", -discount_amount)
 ```
 2. "Long Method" en los códigos "receipt_printer.py", y "shopping_cart.py" lo cual dificulta el entendimiento del código al momento de leerlo y de hacer posibles actualizaciones o ingreso de nuevas funcionalidades
 3. "Feature envy" en los códigos "receipt.py", "receipt_printer.py" y "shopping_cart.py" no utiliza los métodos propios sino que utiliza más los métodos del código "model_objects.py", "receipt_printer.py" y "model_objects.py" respectivamente.
```
    def print_receipt(self, receipt):
        result = ""
        for item in receipt.items:
            receipt_item = self.print_receipt_item(item)
            result += receipt_item

        for discount in receipt.discounts:
            discount_presentation = self.print_discount(discount)
            result += discount_presentation

        result += "\n"
        result += self.present_total(receipt)
        return str(result)
```

## Tecnicas a Utilizar para solucionar Code Smells

1. Refactoring al archivo "receipt_printer.py" realizando la extracción de método, movimiendo la lógica de salto de línea a una nueva clase.
2. Refactoring al archivo "shopping_cart.py" realizando la extracción de método, movimiendo los calculos de ofertas a una nueva clase llamada detalle.
3. Refactoring al detalle de "shopping_cart.py" modificando la lógica del método para evitar la depentencia de los "ifs".

## Características de Clean Code no cumplidas

### Código enfocado: 
 - El código de "shopping_cart.py" contiene la cantidad de productos y adicionalmente realiza los calculos de descuentos.
p.e.
```
@property
    def product_quantities(self):
        return self._product_quantities

    def add_item_quantity(self, product, quantity):
        self._items.append(ProductQuantity(product, quantity))
        if product in self._product_quantities.keys():
            self._product_quantities[product] = self._product_quantities[product] + quantity
        else:
            self._product_quantities[product] = quantity

    def handle_offers(self, receipt, offers, catalog):
        for p in self._product_quantities.keys():
            quantity = self._product_quantities[p]
            if p in offers.keys():
                offer = offers[p]
                unit_price = catalog.unit_price(p)
                quantity_as_int = int(quantity)
                discount = None
                x = 1
                if offer.offer_type == SpecialOfferType.THREE_FOR_TWO:
                    x = 3

                elif offer.offer_type == SpecialOfferType.TWO_FOR_AMOUNT:
                    x = 2
                    if quantity_as_int >= 2:
                        total = offer.argument * (quantity_as_int / x) + quantity_as_int % 2 * unit_price
                        discount_n = unit_price * quantity - total
                        discount = Discount(p, "2 for " + str(offer.argument), -discount_n)

                if offer.offer_type == SpecialOfferType.FIVE_FOR_AMOUNT:
                    x = 5
```

### Entendible
 - El código de "shopping_cart.py" no tiene un código simple incumpliendo el principio KIS.
```
  def handle_offers(self, receipt, offers, catalog):
        for p in self._product_quantities.keys():
            quantity = self._product_quantities[p]
            if p in offers.keys():
                offer = offers[p]
                unit_price = catalog.unit_price(p)
                quantity_as_int = int(quantity)
                discount = None
                x = 1
                if offer.offer_type == SpecialOfferType.THREE_FOR_TWO:
                    x = 3

                elif offer.offer_type == SpecialOfferType.TWO_FOR_AMOUNT:
                    x = 2
                    if quantity_as_int >= 2:
                        total = offer.argument * (quantity_as_int / x) + quantity_as_int % 2 * unit_price
                        discount_n = unit_price * quantity - total
                        discount = Discount(p, "2 for " + str(offer.argument), -discount_n)

                if offer.offer_type == SpecialOfferType.FIVE_FOR_AMOUNT:
                    x = 5

                number_of_x = math.floor(quantity_as_int / x)
                if offer.offer_type == SpecialOfferType.THREE_FOR_TWO and quantity_as_int > 2:
                    discount_amount = quantity * unit_price - (
                                (number_of_x * 2 * unit_price) + quantity_as_int % 3 * unit_price)
                    discount = Discount(p, "3 for 2", -discount_amount)

                if offer.offer_type == SpecialOfferType.TEN_PERCENT_DISCOUNT:
                    discount = Discount(p, str(offer.argument) + "% off",
                                        -quantity * unit_price * offer.argument / 100.0)

                if offer.offer_type == SpecialOfferType.FIVE_FOR_AMOUNT and quantity_as_int >= 5:
                    discount_total = unit_price * quantity - (
                                offer.argument * number_of_x + quantity_as_int % 5 * unit_price)
                    discount = Discount(p, str(x) + " for " + str(offer.argument), -discount_total)

                if discount:
                    receipt.add_discount(discount)
```
### Escalable
 - El código de "shopping_cart.py" no tiene un código escalable en la lógica de descuentos.
```
                if offer.offer_type == SpecialOfferType.THREE_FOR_TWO and quantity_as_int > 2:
                    discount_amount = quantity * unit_price - (
                                (number_of_x * 2 * unit_price) + quantity_as_int % 3 * unit_price)
                    discount = Discount(p, "3 for 2", -discount_amount)

                if offer.offer_type == SpecialOfferType.TEN_PERCENT_DISCOUNT:
                    discount = Discount(p, str(offer.argument) + "% off",
                                        -quantity * unit_price * offer.argument / 100.0)

                if offer.offer_type == SpecialOfferType.FIVE_FOR_AMOUNT and quantity_as_int >= 5:
                    discount_total = unit_price * quantity - (
                                offer.argument * number_of_x + quantity_as_int % 5 * unit_price)
                    discount = Discount(p, str(x) + " for " + str(offer.argument), -discount_total)
```
### Abstracción
 - El código de "shopping_cart.py" utiliza un método largo para el calculo de los descuentos.
 - El código de "receipt_printer.py" utiliza una clase extensa para imprimir el recibo que contiene la lista de productos y la estructura que el recibo debe tener.

## Principios de Programación no cumplidos en el código

### KISS 
No todo es un código simple, en especial el código de "shopping_cart.py" ya que incluye la lógica de los productos y sus cantidades y adicionalmente, la lógica de descuentos con muchos if de por medio.

### SOLID
 - A como está con el código hoy, en especial el código de "shopping_cart.py" está abierto a modificaciones debido a la forma en que se maneja la lógica de descuentos. Esto también implica que la clase de este código esté afectada ya que hace varias cosas, tiene la lógica de cantidad y productos y la lógica de descuento.
 - En la clase del código "receipt_printer.py" incluye el formato del recibo y recibe la información de productos y cantidades.

## Practicas XP para utilizar en el código
Como parte de las sugerencias para complementar la solución revisada, se sugiere utilizar las siguientes prácticas XP para mejorar el proyecto.
### Refactoring
### Diseño Simple
### Integración continua
### Estandarización de códigos
### Juego de planificación
### Pequeños Releases

## Autores 

* **Dave Thomas** - *Descripción Inicial* - [codekata](http://codekata.com/kata/kata01-supermarket-pricing/)
* **Emily Bache** - *Variacion de la Kata* - [emilybache](https://github.com/emilybache)
* **Camilo Alejandro Rojas** - *Trabajo y documentación* - [camrojass](https://github.com/camrojass)
